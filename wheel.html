<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spin the Wheel</title>

  <!-- GSAP 3 and Winwheel 2.7.0 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@2.7.0/Winwheel.min.js"></script>

  <style>
    body {
      background: #111;
      color: white;
      font-family: Verdana, sans-serif;
      text-align: center;
      padding: 20px;
    }

    h1 {
      font-size: 3rem;
      margin-bottom: 20px;
      color: #fff;
      text-shadow: 2px 2px #333;
      user-select: none;
    }

    #wheelContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      max-width: 100vw;
      overflow-x: hidden;
    }
    canvas {
      width: 90vw;
      max-width: 400px;
      height: auto;
    }

    #spinBtn {
      margin-top: 40px;
      padding: 15px 30px;
      font-size: 1.5rem;
      border: none;
      background: linear-gradient(#ff8c00, #ff6600);
      color: white;
      border-radius: 20px;
      box-shadow: 0 6px #b34700;
      cursor: pointer;
      transition: 0.2s ease-in-out;
      user-select: none;
    }

    #spinBtn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    #spinBtn:active:not(:disabled) {
      box-shadow: 0 2px #b34700;
      transform: translateY(4px);
    }

    #spinBtn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }

    #forfeitResult {
      margin-top: 40px;
      font-size: 2rem;
      font-weight: bold;
      color: #00ffcc;
      user-select: none;
      min-height: 48px;
    }

    #nextRoundBtn {
      display: none;
      margin-top: 30px;
      padding: 15px 30px;
      font-size: 1.5rem;
      cursor: pointer;
      border-radius: 12px;
      background: #00bcd4;
      color: #121212;
      border: none;
      user-select: none;
    }
  </style>
</head>
<body>

  <h1>Spin the Wheel - Round <span id="roundNumberDisplay"></span></h1>
  <div id="wheelContainer">
    <canvas id="wheelCanvas" width="400" height="400"></canvas>
    <br />
    <button id="spinBtn">Spin the Wheel</button>
    <div id="forfeitResult"></div>
    <button id="nextRoundBtn">Next Round</button>
  </div>

  <audio id="spinSound" src="sound1.wav" preload="auto"></audio>
  <audio id="winSound" src="sound2.wav" preload="auto"></audio>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    setDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Firebase config (use your actual config here)
  const firebaseConfig = {
    apiKey: "AIzaSyAZxLjMZTYTOLBunk56HqyHkLyPJsQUtjA",
    authDomain: "philcarr-20ac0.firebaseapp.com",
    projectId: "philcarr-20ac0",
    storageBucket: "philcarr-20ac0.firebasestorage.app",
    messagingSenderId: "770728636073",
    appId: "1:770728636073:web:d2bddbee786446c37d03b8",
    measurementId: "G-XRCH682RNE"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Other variables from your code:
  const urlParams = new URLSearchParams(window.location.search);
  let currentRound = parseInt(urlParams.get('round')) || parseInt(localStorage.getItem('currentRound')) || 1;
  if (currentRound > 5) currentRound = 5; // max 5 rounds

  localStorage.setItem('currentRound', currentRound.toString());

  document.getElementById('roundNumberDisplay').textContent = currentRound;

  const spinSound = document.getElementById('spinSound');
  const winSound = document.getElementById('winSound');
  const spinBtn = document.getElementById('spinBtn');
  const forfeitDiv = document.getElementById('forfeitResult');
  const nextRoundBtn = document.getElementById('nextRoundBtn');

  // Firestore doc to track wheel status for current round
  const statusDocRef = doc(db, "wheelStatus", `round${currentRound}`);

  // Listen for realtime updates to sync UI for all players
  onSnapshot(statusDocRef, (docSnap) => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      if (data.spinning) {
        // Someone is spinning now
        spinBtn.disabled = true;
        forfeitDiv.textContent = "Wheel is spinning...";
        nextRoundBtn.style.display = 'none';
      } else {
        // Spin finished
        spinBtn.disabled = false;
        if (data.forfeit) {
          forfeitDiv.textContent = "Forfeit: " + data.forfeit;
          nextRoundBtn.style.display = 'inline-block';
        } else {
          forfeitDiv.textContent = '';
          nextRoundBtn.style.display = 'none';
        }
      }
    } else {
      // No spin in progress or result yet
      spinBtn.disabled = false;
      forfeitDiv.textContent = '';
      nextRoundBtn.style.display = 'none';
    }
  });

  // Wheel setup (your existing code, unchanged)
  const theWheel = new Winwheel({
    canvasId: 'wheelCanvas',
    numSegments: 6,
    outerRadius: 180,
    textFontSize: 16,
    segments: [
      { fillStyle: '#e74c3c', text: 'Dance on table' },
      { fillStyle: '#2ecc71', text: 'Wear a dress' },
      { fillStyle: '#3498db', text: 'Sing karaoke' },
      { fillStyle: '#f1c40f', text: 'Shot of tequila' },
      { fillStyle: '#9b59b6', text: 'Selfie with a random' },
      { fillStyle: '#1abc9c', text: 'Jump in pool' },
    ],
    animation: {
      type: 'spinToStop',
      duration: 5,
      spins: 8,
      callbackFinished: async function (indicatedSegment) {
        // Update Firestore: spinning false + save forfeit text
        await setDoc(statusDocRef, {
          spinning: false,
          forfeit: indicatedSegment.text
        });

        // Play sounds and update UI - your existing code
        spinSound.pause();
        spinSound.currentTime = 0;
        winSound.currentTime = 0;
        winSound.play().catch(e => console.warn('Win sound play failed:', e));
        forfeitDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  });

  // Unlock audio on first user interaction (your existing code)
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  document.addEventListener('click', function unlockAudio() {
    audioCtx.resume();
    [spinSound, winSound].forEach(sound => {
      sound.muted = true;
      sound.play().then(() => {
        sound.pause();
        sound.currentTime = 0;
        sound.muted = false;
      }).catch(() => {});
    });
    document.removeEventListener('click', unlockAudio);
  });

  spinBtn.addEventListener('click', async () => {
    // Write spin in progress to Firestore
    await setDoc(statusDocRef, {
      spinning: true,
      forfeit: null
    });

    // Your existing spin start code:
    spinBtn.disabled = true;
    forfeitDiv.textContent = '';
    nextRoundBtn.style.display = 'none';

    theWheel.stopAnimation(false);
    theWheel.rotationAngle = 0;
    theWheel.startAnimation();

    setTimeout(() => {
      spinSound.currentTime = 0;
      spinSound.play().catch(e => console.warn('Spin sound play failed:', e));
    }, 20);
  });

  nextRoundBtn.addEventListener('click', () => {
    let nextRound = currentRound + 1;
    localStorage.setItem('currentRound', nextRound.toString());

    if (nextRound > 5) {
      window.location.href = 'winners.html';
    } else {
      window.location.href = `round.html?round=${nextRound}`;
    }
  });
</script>


</body>
</html>
