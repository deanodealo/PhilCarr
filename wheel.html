<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spin the Wheel</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
    #spinBtn:disabled { background: #ccc; cursor: not-allowed; }
    #forfeit { margin-top: 1rem; font-weight: bold; font-size: 1.2rem; }
    #waitingMsg { margin-top: 1rem; font-style: italic; }
  </style>
</head>
<body>

<h1>Spin the Wheel</h1>
<p id="instructions"></p>

<button id="spinBtn" disabled>Spin the Wheel</button>

<div id="waitingMsg"></div>
<div id="forfeit"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    onSnapshot,
    updateDoc,
    arrayUnion,
    getDoc,
    collection,
    getDocs
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAZxLjMZTYTOLBunk56HqyHkLyPJsQUtjA",
    authDomain: "philcarr-20ac0.firebaseapp.com",
    projectId: "philcarr-20ac0",
    storageBucket: "philcarr-20ac0.firebasestorage.app",
    messagingSenderId: "770728636073",
    appId: "1:770728636073:web:d2bddbee786446c37d03b8",
    measurementId: "G-XRCH682RNE"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.addEventListener('DOMContentLoaded', () => {
    console.log('Wheel page script loaded and DOM ready');

const urlParams = new URLSearchParams(window.location.search);
const roundNumber = parseInt(urlParams.get('round') || '1');
const gameId = urlParams.get('gameId') || 'defaultGame';  // ADD THIS LINE
const playerName = localStorage.getItem('playerName') || 'Unknown Player';
const gameStateDocRef = doc(db, 'games', gameId);          // USE gameId HERE
const spinBtn = document.getElementById('spinBtn');
const waitingMsg = document.getElementById('waitingMsg');
const forfeitDiv = document.getElementById('forfeit');
const instructions = document.getElementById('instructions');


    let hasSpun = false;
    let totalPlayersCount = 0;

    async function fetchTotalPlayers() {
      try {
        const playersSnapshot = await getDocs(collection(db, 'players'));
        totalPlayersCount = playersSnapshot.size;
        return playersSnapshot.docs.map(doc => ({
          name: doc.id,
          score: doc.data().score || 0
        }));
      } catch (e) {
        console.error('Failed to fetch total players:', e);
        totalPlayersCount = 0;
        return [];
      }
    }

    async function markPlayerFinished() {
      try {
        const gameSnap = await getDoc(gameStateDocRef);
        if (!gameSnap.exists()) {
          console.log('No game state document found in markPlayerFinished');
          return;
        }
        const data = gameSnap.data();
        const finished = data.playersFinishedRound || [];
        if (!finished.includes(playerName)) {
          await updateDoc(gameStateDocRef, {
            playersFinishedRound: arrayUnion(playerName)
          });
          console.log(`Marked player "${playerName}" as finished.`);
        }
      } catch (err) {
        console.error('Error in markPlayerFinished:', err);
      }
    }

    async function spinWheel() {
      try {
        console.log('spinWheel started');
        spinBtn.disabled = true;
        waitingMsg.textContent = `${playerName} is spinning...`;
        forfeitDiv.textContent = '';

        await new Promise(res => setTimeout(res, 3000));
        console.log('Spin delay complete');

        const forfeits = ['Sing a song', 'Do 10 push-ups', 'Dance for 30 seconds', 'Tell a joke'];
        const chosenForfeit = forfeits[Math.floor(Math.random() * forfeits.length)];
        console.log('Chosen forfeit:', chosenForfeit);

        const gameSnap = await getDoc(gameStateDocRef);
        if (!gameSnap.exists()) {
          console.log('No game state document found during spinWheel');
          return;
        }

        const data = gameSnap.data();
        const spinsDone = data.spinsDone || [];

        await updateDoc(gameStateDocRef, {
          spinsDone: [...spinsDone, playerName],
          currentSpinner: null,
          forfeitResult: chosenForfeit
        });
        console.log('Firestore updated with spin result');

        hasSpun = true;
        waitingMsg.textContent = '';
        forfeitDiv.textContent = `Forfeit: ${chosenForfeit}`;
        console.log('spinWheel finished');
      } catch (error) {
        console.error('Error in spinWheel:', error);
        waitingMsg.textContent = 'Error occurred during spin. Please try again.';
      }
    }

    // Attach event listener to spin button
    spinBtn.addEventListener('click', async () => {
      console.log('Spin button clicked');
      await spinWheel();
    });



onSnapshot(gameStateDocRef, async (docSnap) => {
  console.log('onSnapshot listener triggered');
  if (!docSnap.exists()) {
    console.log('No Games/defaultGame document found');
    return;
  }

  const data = docSnap.data();

  if (data.phase === 'winners') {
    console.log('Phase is winners â€” redirecting to winners.html');
    setTimeout(() => {
      window.location.href = `winners.html?gameId=${gameId}`;
    }, 0);
    return;
  }

  if (data.phase && data.phase !== `wheel${roundNumber}`) {
    if (data.phase.startsWith('round')) {
      const newRound = parseInt(data.phase.replace('round', ''), 10);
      console.log(`Phase changed: redirecting to round ${newRound}`);
      window.location.href = `round.html?round=${newRound}`;
      return;
    } else if (data.phase === 'leaderboard') {
      console.log('Phase changed: redirecting to leaderboard');
      window.location.href = `leaderboard.html`;
      return;
    }
  }

      const playersFinishedRound = data.playersFinishedRound || [];
      const spinEligiblePlayers = data.spinEligiblePlayers || [];
      const spinsDone = data.spinsDone || [];
      const currentSpinner = data.currentSpinner || null;
      const forfeitResult = data.forfeitResult || '';

      await fetchTotalPlayers();

      console.log('Player:', playerName);
      console.log('Spin Eligible Players:', spinEligiblePlayers);
      console.log('Spins Done:', spinsDone);
      console.log('Current Spinner:', currentSpinner);
      console.log('Is Spin Eligible:', spinEligiblePlayers.includes(playerName));
      console.log('Has Spun:', spinsDone.includes(playerName));

      instructions.textContent = `Players finished this round: ${playersFinishedRound.length} of ${totalPlayersCount}`;

      if (playersFinishedRound.length < totalPlayersCount) {
        spinBtn.disabled = true;
        waitingMsg.textContent = `Waiting for all players to finish round ${roundNumber}... (${playersFinishedRound.length} of ${totalPlayersCount})`;
        forfeitDiv.textContent = '';
        return;
      }

      const normalizedPlayerName = playerName.trim().toLowerCase();
      const normalizedSpinEligible = spinEligiblePlayers.map(p => p.trim().toLowerCase());

      const canSpin = normalizedSpinEligible.includes(normalizedPlayerName) &&
                      !spinsDone.includes(playerName) &&
                      (currentSpinner === null || currentSpinner === playerName);

      console.log('--- Spin Button Debug ---');
      console.log('normalizedPlayerName:', `"${normalizedPlayerName}"`);
      console.log('normalizedSpinEligible:', normalizedSpinEligible);
      console.log('spinsDone:', spinsDone);
      console.log('currentSpinner:', currentSpinner);
      console.log('canSpin:', canSpin);

      if (canSpin) {
        console.log('Enabling spin button');
        spinBtn.disabled = false;
        waitingMsg.textContent = '';
      } else if (currentSpinner && currentSpinner !== playerName) {
        console.log('Disabling spin button - someone else is spinning');
        spinBtn.disabled = true;
        waitingMsg.textContent = `${currentSpinner} is spinning the wheel...`;
      } else {
        console.log('Disabling spin button - conditions not met');
        spinBtn.disabled = true;
        waitingMsg.textContent = '';
      }

      forfeitDiv.textContent = forfeitResult ? `Forfeit: ${forfeitResult}` : '';
      instructions.textContent = `Players eligible to spin: ${spinEligiblePlayers.join(', ')}`;

    });

    (async () => {
      await fetchTotalPlayers();
      await markPlayerFinished();
    })();
  });
</script>





</body>
</html>
