<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* your existing styles here ... */
    body {
      background: #524f4f;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      flex-direction: column;
    }
    .leaderboard-container {
      width: 350px;
      background: #222;
      border-radius: 16px;
      padding: 20px;
      box-shadow:
        0 4px 6px rgba(0,0,0,0.6),
        inset 0 0 10px #00bcd4;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .leaderboard-title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #00bcd4;
      text-shadow: 0 0 8px #00bcd4;
      user-select: none;
    }
    .spin-status {
      margin-bottom: 20px;
      font-size: 1.2rem;
      color: #00ffcc;
      min-height: 24px;
      user-select: none;
      text-align: center;
    }
    .leaderboard-list {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }
    .leaderboard-item {
      background: linear-gradient(145deg, #272727, #1c1c1c);
      border-radius: 12px;
      box-shadow:
        3px 3px 6px #1a1a1a,
        -3px -3px 6px #323232;
      padding: 15px 20px;
      font-size: 1.3rem;
      font-weight: 600;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: default;
      user-select: none;
      transition: box-shadow 0.3s ease;
    }
    .leaderboard-item:hover {
      box-shadow:
        6px 6px 12px #121212,
        -6px -6px 12px #404040;
    }
    .score {
      background: #00bcd4;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 700;
      color: #121212;
      min-width: 45px;
      text-align: center;
      box-shadow: 0 0 8px #00bcd4;
    }
    #spinWheelBtn {
      font-size: 1.8rem;
      font-weight: 900;
      color: #121212;
      background: linear-gradient(145deg, #00bcd4, #0097a7);
      border: 2px solid #008c9e;
      border-radius: 30px;
      padding: 15px 0;
      width: 100%;
      cursor: pointer;
      text-align: center;
      user-select: none;
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }
    #spinWheelBtn:disabled {
      background: #555 !important;
      border-color: #444 !important;
      color: #888 !important;
      cursor: not-allowed;
      box-shadow: none !important;
      transform: none !important;
    }
    #spinWheelBtn:hover:not(:disabled),
    #spinWheelBtn:focus:not(:disabled) {
      background: linear-gradient(145deg, #0097a7, #00bcd4);
      color: #fff;
      outline: none;
      box-shadow:
        inset 2px 2px 6px #006870,
        inset -2px -2px 6px #00d4db;
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div class="leaderboard-container">
    <div class="leaderboard-title" id="leaderboardTitle">Leaderboard</div>
    <div class="spin-status" id="spinStatus">Loading spin status...</div>
    <div class="leaderboard-list" id="leaderboardList">
      <!-- Player score items go here -->
    </div>
    <button id="spinWheelBtn" type="button">Last place - Click to Spin the Wheel!</button>

    <!-- Spin sound audio -->
    <audio id="spinWheelSound" src="sound4.mp3" preload="auto"></audio>
  </div>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    onSnapshot,
    doc,
    setDoc,
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAZxLjMZTYTOLBunk56HqyHkLyPJsQUtjA",
    authDomain: "philcarr-20ac0.firebaseapp.com",
    projectId: "philcarr-20ac0",
    storageBucket: "philcarr-20ac0.firebasestorage.app",
    messagingSenderId: "770728636073",
    appId: "1:770728636073:web:d2bddbee786446c37d03b8",
    measurementId: "G-XRCH682RNE"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const leaderboardList = document.getElementById('leaderboardList');
  const leaderboardTitle = document.getElementById('leaderboardTitle');
  const spinWheelBtn = document.getElementById('spinWheelBtn');
  const spinWheelSound = document.getElementById('spinWheelSound');
  const spinStatus = document.getElementById('spinStatus');

  const currentRound = parseInt(localStorage.getItem('currentRound')) || 1;
  const playerName = localStorage.getItem('playerName') || '';
  leaderboardTitle.textContent = `Leaderboard - Round ${currentRound}`;

  const playersCol = collection(db, 'players');
  const playersQuery = query(playersCol, orderBy('score', 'desc'));

  onSnapshot(playersQuery, (snapshot) => {
    leaderboardList.innerHTML = '';

    let allFinished = true;
    let lowestScore = Infinity;
    let lastPlacePlayers = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      const name = doc.id;
      const score = data.score ?? 0;
      const finishedRound = data.finishedRound ?? 0;

      if (finishedRound < currentRound) {
        allFinished = false;
      }

      // Track last place players (lowest score)
      if (score < lowestScore) {
        lowestScore = score;
        lastPlacePlayers = [name];
      } else if (score === lowestScore) {
        lastPlacePlayers.push(name);
      }

      const item = document.createElement('div');
      item.className = 'leaderboard-item';
      item.innerHTML = `
        <span class="player-name">${name}</span>
        <span class="score">${score}</span>
      `;
      leaderboardList.appendChild(item);
    });

    if (allFinished) {
      spinStatus.textContent = 'All players finished. Ready to spin the wheel!';

      // Enable spin button only if current player is last place
      if (lastPlacePlayers.includes(playerName)) {
        spinWheelBtn.disabled = false;
        spinWheelBtn.textContent = 'You are last place - Click to Spin the Wheel!';
      } else {
        spinWheelBtn.disabled = true;
        spinWheelBtn.textContent = 'Waiting for last place player to spin...';
      }
    } else {
      spinStatus.textContent = `Waiting for all players to finish round ${currentRound}...`;
      spinWheelBtn.disabled = true;
      spinWheelBtn.textContent = 'Waiting for players...';
    }
  });

  const wheelStatusDoc = doc(db, 'wheelStatus', `round${currentRound}`);
  onSnapshot(wheelStatusDoc, (docSnap) => {
    if (!docSnap.exists()) return;

    const data = docSnap.data();
    const spinning = data.spinning || false;
    const forfeit = data.forfeit || null;

    if (spinning) {
      spinStatus.textContent = 'Wheel is spinning...';
      spinWheelBtn.disabled = true;
      spinWheelBtn.textContent = 'Wheel spinning, please wait...';

      // Redirect all users to wheel page to watch spin if not already there
      if (!window.location.href.includes('wheel.html')) {
        window.location.href = `wheel.html?round=${currentRound}`;
      }
    } else if (forfeit) {
      spinStatus.textContent = `Forfeit: ${forfeit}`;
      spinWheelBtn.disabled = true;
      spinWheelBtn.textContent = 'Spin complete';
    }
  });

  spinWheelBtn.addEventListener('click', async () => {
    try {
      spinWheelSound.currentTime = 0;
      await spinWheelSound.play();

      await setDoc(wheelStatusDoc, { spinning: true, forfeit: null }, { merge: true });

      spinWheelSound.onended = () => {
        window.location.href = `wheel.html?round=${currentRound}`;
      };
    } catch (e) {
      console.error('Failed to play spin sound or update Firestore:', e);
      window.location.href = `wheel.html?round=${currentRound}`;
    }
  });
</script>



</body>
</html>
