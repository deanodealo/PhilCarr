<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Host Control</title>
  <style>
body {
  font-family: Arial, sans-serif;
  max-width: 600px;
  margin: auto;
  padding: 20px;
}

h1 {
  font-size: 1.5rem;
  text-align: center;
}

div {
  margin-bottom: 20px;
}

button {
  width: 100%;
  margin: 8px 0;
  padding: 12px;
  font-size: 1rem;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  background: #007bff;
  color: white;
  transition: background 0.2s ease;
}

button:disabled {
  background: #cccccc;
  cursor: not-allowed;
}

button:hover:not(:disabled) {
  background: #0056b3;
}

#status {
  margin-top: 15px;
  text-align: center;
  font-weight: bold;
}

/* Make sure text scales nicely on mobile */
@media (max-width: 480px) {
  body {
    padding: 10px;
  }
  h1 {
    font-size: 1.2rem;
  }
  button {
    font-size: 0.9rem;
    padding: 10px;
  }
}

  </style>
</head>
<body>

<script type="module">
  // Preload leaderboard sound for mobile devices
  const leaderboardSound = new Audio('leaderboard.mp3');
  leaderboardSound.preload = 'auto';

  // Unlock audio on first user interaction (needed for iOS/Android)
  function unlockAudio() {
    leaderboardSound.play().then(() => leaderboardSound.pause());
    leaderboardSound.currentTime = 0;
    document.body.removeEventListener('touchstart', unlockAudio);
  }

  document.body.addEventListener('touchstart', unlockAudio, { once: true });
</script>

  <h1>Quiz Host Control</h1>
  <div>
    <p>Current Phase: <span id="currentPhase">Loading...</span></p>
    <p>Current Round: <span id="currentRound">-</span></p>
    <p>Players Finished This Round: <span id="playersFinished">0</span></p>
    <p>Total Players: <span id="totalPlayers">0</span></p>
  </div>

  <button id="startRoundBtn">Start Round 1</button>
  <button id="goToWheelBtn" disabled>Go to Wheel</button>
  <button id="nextRoundBtn" disabled>Next Round</button>
 
  <button id="resetBtn">Reset Game</button>

  <div id="status"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { 
    getFirestore, 
    doc, 
    onSnapshot, 
    updateDoc, 
    collection, 
    getDocs, 
    getDoc,
    deleteField,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAZxLjMZTYTOLBunk56HqyHkLyPJsQUtjA",
    authDomain: "philcarr-20ac0.firebaseapp.com",
    projectId: "philcarr-20ac0",
    storageBucket: "philcarr-20ac0.firebasestorage.app",
    messagingSenderId: "770728636073",
    appId: "1:770728636073:web:d2bddbee786446c37d03b8",
    measurementId: "G-XRCH682RNE"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const gameId = 'defaultGame';  // Or get from URL if needed
  const gameDocRef = doc(db, 'games', gameId);
  const playersCollectionRef = collection(db, 'players');

  const currentPhaseSpan = document.getElementById('currentPhase');
  const currentRoundSpan = document.getElementById('currentRound');
  const playersFinishedSpan = document.getElementById('playersFinished');
  const totalPlayersSpan = document.getElementById('totalPlayers');
  const startRoundBtn = document.getElementById('startRoundBtn');
  const goToWheelBtn = document.getElementById('goToWheelBtn');
  const nextRoundBtn = document.getElementById('nextRoundBtn');
  const statusDiv = document.getElementById('status');

  let currentPhase = null;
  let currentRound = 0;
  let totalPlayers = 0;
  let playersFinishedRound = [];

  // üîä Leaderboard sound
  const leaderboardSound = new Audio('leaderboard.mp3');
  leaderboardSound.load();
  // Unlock sound on mobile
  document.body.addEventListener('touchstart', () => {
    leaderboardSound.play().then(() => leaderboardSound.pause());
  }, { once: true });

  async function fetchTotalPlayers() {
    const snapshot = await getDocs(playersCollectionRef);
    totalPlayers = snapshot.size;
    totalPlayersSpan.textContent = totalPlayers;
  }

  onSnapshot(gameDocRef, async (docSnap) => {
    if (!docSnap.exists()) {
      currentPhaseSpan.textContent = 'No game data found';
      statusDiv.textContent = 'No game data found';
      return;
    }
    const data = docSnap.data();

    currentPhase = data.phase || 'Not started';
    currentRound = data.round || 0;
    playersFinishedRound = data.playersFinishedRound || [];

    currentPhaseSpan.textContent = currentPhase;
    currentRoundSpan.textContent = currentRound;
    playersFinishedSpan.textContent = playersFinishedRound.length;

    await fetchTotalPlayers();

    // Button enabling logic
    if (currentPhase === 'not started' || currentPhase === 'results' || currentPhase === 'round0') {
      startRoundBtn.disabled = false;
      goToWheelBtn.disabled = true;
      nextRoundBtn.disabled = true;
    } else if (currentPhase.startsWith('round')) {
      startRoundBtn.disabled = true;
      goToWheelBtn.disabled = playersFinishedRound.length < totalPlayers;
      nextRoundBtn.disabled = true;
    } else if (currentPhase.startsWith('wheel')) {
      startRoundBtn.disabled = true;
      goToWheelBtn.disabled = true;
      nextRoundBtn.disabled = false;
    } else {
      startRoundBtn.disabled = false;
      goToWheelBtn.disabled = true;
      nextRoundBtn.disabled = true;
    }
  });

  // Start Round 1 button
  startRoundBtn.addEventListener('click', async () => {
    try {
      await updateDoc(gameDocRef, {
        phase: 'round1',
        round: 1,
        playersFinishedRound: [],
        spinEligiblePlayers: [],
        spinsDone: [],
        currentSpinner: null,
        forfeitResult: null,
      });
      statusDiv.textContent = 'Round 1 started.';
    } catch (e) {
      statusDiv.textContent = 'Error starting round: ' + e.message;
    }
  });

  // Go To Wheel button
  goToWheelBtn.addEventListener('click', async () => {
    try {
      const gameSnap = await getDoc(gameDocRef);
      let roundFromDb = 1;
      let playersFinished = [];

      if (gameSnap.exists()) {
        const gameData = gameSnap.data();
        roundFromDb = gameData.round || 1;
        playersFinished = gameData.playersFinishedRound || [];
      }

      if (playersFinished.length === 0) {
        statusDiv.textContent = 'No players finished the round yet.';
        return;
      }

      const playersScores = await Promise.all(
        playersFinished.map(async (playerName) => {
          const playerDocRef = doc(db, 'players', playerName);
          const playerSnap = await getDoc(playerDocRef);
          if (playerSnap.exists()) {
            const data = playerSnap.data();
            const roundScore = data.roundScores?.[roundFromDb] ?? 0;
            return { name: playerName, score: roundScore };
          } else {
            return { name: playerName, score: 0 };
          }
        })
      );

      const minScore = Math.min(...playersScores.map(p => p.score));
      const lowestScorers = playersScores
        .filter(p => p.score === minScore)
        .map(p => p.name);

      await updateDoc(gameDocRef, {
        phase: `wheel${roundFromDb}`,
        round: roundFromDb,
        spinEligiblePlayers: lowestScorers,
        spinsDone: [],
        currentSpinner: null,
        forfeitResult: null,
      });

      statusDiv.textContent = `Moved to wheel phase for round ${roundFromDb}. Eligible spinner(s): ${lowestScorers.join(', ')}`;

    } catch (e) {
      statusDiv.textContent = 'Error going to wheel: ' + e.message;
      console.error(e);
    }
  });

  // Next Round button
  nextRoundBtn.addEventListener('click', async () => {
    try {
      if (currentRound === 5) {
        // üîä Play leaderboard sound
        leaderboardSound.currentTime = 0;
        leaderboardSound.play().catch(err => console.log('Sound play failed:', err));

        // Final round ‚Äî go to winners/leaderboard
        await updateDoc(gameDocRef, {
          phase: 'winners',
          round: currentRound,
          playersFinishedRound: [],
          spinEligiblePlayers: [],
          spinsDone: [],
          currentSpinner: null,
          forfeitResult: null,
        });
        statusDiv.textContent = 'Quiz ended. Showing winners.';
      } else {
        const nextRound = currentRound + 1;
        await updateDoc(gameDocRef, {
          phase: `round${nextRound}`,
          round: nextRound,
          playersFinishedRound: [],
          spinEligiblePlayers: [],
          spinsDone: [],
          currentSpinner: null,
          forfeitResult: null,
        });
        statusDiv.textContent = `Moved to round ${nextRound}.`;
      }
    } catch (e) {
      console.error('Error starting next round:', e);
      statusDiv.textContent = 'Error starting next round: ' + e.message;
    }
  });

  // Reset game
  async function resetGame() {
    try {
      await updateDoc(gameDocRef, {
        currentSpinner: deleteField(),
        forfeitResult: deleteField(),
        playersFinishedRound: deleteField(),
        spinEligiblePlayers: deleteField(),
        spinsDone: deleteField(),
        phase: deleteField(),
        round: deleteField(),
      });

      const snapshot = await getDocs(playersCollectionRef);
      for (const playerDoc of snapshot.docs) {
        await deleteDoc(doc(db, "players", playerDoc.id));
      }

      statusDiv.textContent = "‚úÖ Game reset complete.";
    } catch (err) {
      console.error("Reset failed:", err);
      statusDiv.textContent = "‚ùå Error: " + err.message;
    }
  }

  const resetBtn = document.getElementById("resetBtn");
  resetBtn.addEventListener("click", resetGame);
</script>


</body>
</html>
